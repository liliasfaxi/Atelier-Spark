<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Cours et Travaux Pratiques pour se familiariser avec Apache Spark"><meta name=author content="Lilia Sfaxi"><link href=http://liliasfaxi.github.io/Atelier-Spark/p6-stream/ rel=canonical><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.10"><title>P6 - Spark Streaming - Atelier Apache Spark</title><link rel=stylesheet href=../assets/stylesheets/main.d6be258b.min.css><link rel=stylesheet href=../assets/stylesheets/palette.e6a45f82.min.css><meta name=theme-color content=#546d78><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/timeago.css><link rel=stylesheet href=../stylesheets/extra.css><link rel=stylesheet href=../stylesheets/links.css><script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=blue-grey data-md-color-accent=amber> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#partie-6-spark-streaming class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Atelier Apache Spark" class="md-header__button md-logo" aria-label="Atelier Apache Spark" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Atelier Apache Spark </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> P6 - Spark Streaming </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/liliasfaxi/Atelier-Spark/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> liliasfaxi/Atelier-Spark </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Atelier Apache Spark" class="md-nav__button md-logo" aria-label="Atelier Apache Spark" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> Atelier Apache Spark </label> <div class=md-nav__source> <a href=https://github.com/liliasfaxi/Atelier-Spark/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> liliasfaxi/Atelier-Spark </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Atelier Apache Spark </a> </li> <li class=md-nav__item> <a href=../p1-big-data/ class=md-nav__link> P1 - Introduction au Big Data </a> </li> <li class=md-nav__item> <a href=../p2-spark/ class=md-nav__link> P2 - Introduction à Apache Spark </a> </li> <li class=md-nav__item> <a href=../p3-install/ class=md-nav__link> P3 - Installation de Spark </a> </li> <li class=md-nav__item> <a href=../p4-batch/ class=md-nav__link> P4 - RDD et Batch Processing avec Spark </a> </li> <li class=md-nav__item> <a href=../p5-sql/ class=md-nav__link> P5 - Spark SQL </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> P6 - Spark Streaming <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> P6 - Spark Streaming </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#partie-6-spark-streaming class=md-nav__link> Partie 6 - Spark Streaming </a> <nav class=md-nav aria-label="Partie 6 - Spark Streaming"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#presentation-de-spark-streaming class=md-nav__link> Présentation de Spark Streaming </a> </li> <li class=md-nav__item> <a href=#les-dstreams class=md-nav__link> Les DStreams </a> </li> <li class=md-nav__item> <a href=#environnement-et-code class=md-nav__link> Environnement et Code </a> <nav class=md-nav aria-label="Environnement et Code"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#test-du-code-en-local class=md-nav__link> Test du code en Local </a> </li> <li class=md-nav__item> <a href=#lancement-du-code-sur-le-cluster class=md-nav__link> Lancement du code sur le cluster </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> Références </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../p7-ml/ class=md-nav__link> P7 - Spark MLLib </a> </li> <li class=md-nav__item> <a href=../p8-graphx/ class=md-nav__link> P8 - Spark GraphX </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#partie-6-spark-streaming class=md-nav__link> Partie 6 - Spark Streaming </a> <nav class=md-nav aria-label="Partie 6 - Spark Streaming"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#presentation-de-spark-streaming class=md-nav__link> Présentation de Spark Streaming </a> </li> <li class=md-nav__item> <a href=#les-dstreams class=md-nav__link> Les DStreams </a> </li> <li class=md-nav__item> <a href=#environnement-et-code class=md-nav__link> Environnement et Code </a> <nav class=md-nav aria-label="Environnement et Code"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#test-du-code-en-local class=md-nav__link> Test du code en Local </a> </li> <li class=md-nav__item> <a href=#lancement-du-code-sur-le-cluster class=md-nav__link> Lancement du code sur le cluster </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> Références </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/liliasfaxi/Atelier-Spark/edit/master/docs/p6-stream.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>P6 - Spark Streaming</h1> <h2 id=partie-6-spark-streaming>Partie 6 - Spark Streaming<a class=headerlink href=#partie-6-spark-streaming title="Permanent link">&para;</a></h2> <p><center><img src=../img/p6/streaming.png width=600pt></center></p> <h3 id=presentation-de-spark-streaming>Présentation de Spark Streaming<a class=headerlink href=#presentation-de-spark-streaming title="Permanent link">&para;</a></h3> <p>Un flux de données (ou <em>data stream</em>) est une séquence non bornée de données qui arrive de manière continue. Le streaming divise le flux continu des données en unités discrètes pour les traiter. Le traitement de flux est un traitement à faible latence, et une analyse des données en streaming.</p> <p><strong>Spark Streaming</strong> a été ajouté à Apache Spark en 2013, comme extension de l'API de base de Spark, qui fournit un traitement de flux scalable, à haut débit et tolérant aux fautes. L'ingestion de données peut être réalisée par plusieurs outils tels que <a href=https://kafka.apache.org/ >Apache Kafka</a>, <a href=https://flume.apache.org/ >Apache Flume</a> ou <a href=https://aws.amazon.com/kinesis/ >Amazon Kinesis</a>, et le traitement peut être fait grâce à des algorithmes complexes, exprimés par des fonctions de haut niveau tel que <em>map</em>, <em>reduce</em>, <em>join</em>, etc. Finalement, les données traitées peuvent être envoyées vers des systèmes de fichiers, bases de données ou tableaux de bord en temps réels. Il est même possible de réaliser des algorithmes de machine learning et de traitement de graphes sur les flux de données.</p> <p><center><img src=../img/p6/spark-streaming.png width=400></center></p> <p>En interne, il fonctionne comme suit: Spark Streaming reçoit des données en streaming et les divise en micro-batches, qui sont ensuite calculés par le moteur de spark pour générer le flux final de résultats.</p> <p><center><img src=../img/p6/micro-batch.png width=500></center></p> <p>Au lieu de traiter les flux de données un élément à la fois, Spark Streaming les discrétise en micro-lots. En d'autres termes, les récepteurs de Spark Streaming acceptent les données en parallèle et les envoient sur la mémoire des noeuds Workers de Spark. Ensuite, le moteur optimisé de Spark exécuter de courtes tâches pour traiter les lots et envoyer les résultats à d'autre systèmes.</p> <p>Contrairement au modèle d'opérateur continu, où le traitement est statiquement alloué à un noeud, les tâches de Spark sont affectées aux Workers de façon dynamique, sur la base de la localité des données et des ressources disponibles. Ceci permet une meilleure répartition des charges et une récupération plus rapide en cas de faute.</p> <p>Chaque lot de données est un RDD dans Spark. Ceci permet aux données en streaming d'être traitées grâche à n'importe quel code ou bibliothèque Spark.</p> <h3 id=les-dstreams>Les DStreams<a class=headerlink href=#les-dstreams title="Permanent link">&para;</a></h3> <p>Spark Streaming divise le flux de données en lots appelés DStream (<em>Discretized Stream</em>), qui représentent fondamentalement une séquence de RDDs.</p> <p><center><img src=../img/p6/dstream.jpg width=600pt>[^data-flair]</center></p> <p>Spark DStream est l'abstraction de base de Spark Streaming. C'est un flux continu de données, qui reçoit en entrée des données à partir de sources diverses. Il peut également être un flux de données généré à partir d'un flux en entrée. DStream est un flux continu de RDD. Chaque RDD contient des données sur un intervalle particulier.</p> <p>Chaque opération sur un DStream s'applique à tous les RDD sous-jacents. DStream offre ainsi au développeur une API de haut niveau pour faciliter le travail sur les données en streaming.</p> <p>Les opérations sur le DStreams peuvent être:</p> <ul> <li><strong>Transformations</strong>: qui peuvent être:<ul> <li>Sans état (<em>Stateless</em>): ce sont des transformations où le traitement sur un lot n'a pas de dépendance avec les lots précédents. Les transformations sans état sont de simples transformations RDD. Elles s'appliquent sur chaque batch (et sur chaque RDD) du DStream. Ceci inclut des transformations classiques telles que <em>map</em>, <em>filter</em>, <em>reduceByKey</em>, etc.</li> <li>Avec état (<em>Stateful</em>): ces transformations utilisent des données ou des résultats intermédiaires provenant des batches précédents. Les transformations avec état sont des opérations sur les DStreams qui suivent l'évolution des données à travers le temps. Les deux types de transformations avec état sont les <em>windowed operations</em>, qui opèrent sur une fenêtre glissante de périodes de temps, et la <em>updateStateByKey</em>, utilisée pour suivre l'état à travers les évènements de chaque clef.</li> </ul> </li> <li><strong>Output Operations</strong>: elles sont réalisées pour renvoyer un résultat après les transformations. C'est l'équivalent des <em>actions</em> pour les RDDs. On peut citer: <em>print</em>, <em>save</em>, etc.</li> </ul> <h3 id=environnement-et-code>Environnement et Code<a class=headerlink href=#environnement-et-code title="Permanent link">&para;</a></h3> <p>Nous allons commencer par tester le streaming en local, comme d'habitude. Pour cela:</p> <ol> <li>Commencer par créer un nouveau projet Maven, avec le fichier pom suivant: <div class=highlight><pre><span></span><code><span class=cp>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
       <span class=na>xmlns:xsi=</span><span class=s>&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class=na>xsi:schemaLocation=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class=nt>&gt;</span>
  <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>

  <span class=nt>&lt;groupId&gt;</span>spark.streaming<span class=nt>&lt;/groupId&gt;</span>
  <span class=nt>&lt;artifactId&gt;</span>stream<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;version&gt;</span>1<span class=nt>&lt;/version&gt;</span>

  <span class=nt>&lt;dependencies&gt;</span>
      <span class=nt>&lt;dependency&gt;</span>
          <span class=nt>&lt;groupId&gt;</span>org.apache.spark<span class=nt>&lt;/groupId&gt;</span>
          <span class=nt>&lt;artifactId&gt;</span>spark-core_2.11<span class=nt>&lt;/artifactId&gt;</span>
          <span class=nt>&lt;version&gt;</span>2.2.1<span class=nt>&lt;/version&gt;</span>
      <span class=nt>&lt;/dependency&gt;</span>
      <span class=nt>&lt;dependency&gt;</span>
          <span class=nt>&lt;groupId&gt;</span>org.apache.spark<span class=nt>&lt;/groupId&gt;</span>
          <span class=nt>&lt;artifactId&gt;</span>spark-streaming_2.11<span class=nt>&lt;/artifactId&gt;</span>
          <span class=nt>&lt;version&gt;</span>2.2.1<span class=nt>&lt;/version&gt;</span>
      <span class=nt>&lt;/dependency&gt;</span>
  <span class=nt>&lt;/dependencies&gt;</span>
  <span class=nt>&lt;build&gt;</span>
      <span class=nt>&lt;plugins&gt;</span>
          <span class=nt>&lt;plugin&gt;</span>
              <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
              <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
              <span class=nt>&lt;version&gt;</span>3.1<span class=nt>&lt;/version&gt;</span>
              <span class=nt>&lt;configuration&gt;</span>
                  <span class=nt>&lt;source&gt;</span>1.8<span class=nt>&lt;/source&gt;</span>
                  <span class=nt>&lt;target&gt;</span>1.8<span class=nt>&lt;/target&gt;</span>
              <span class=nt>&lt;/configuration&gt;</span>
          <span class=nt>&lt;/plugin&gt;</span>
      <span class=nt>&lt;/plugins&gt;</span>
  <span class=nt>&lt;/build&gt;</span>

<span class=nt>&lt;/project&gt;</span>
</code></pre></div></li> <li>Créer une classe <em>tn.spark.streaming.Stream</em> avec le code suivant:</li> </ol> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.spark.streaming</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.apache.spark.SparkConf</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.streaming.Durations</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.streaming.api.java.JavaDStream</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.streaming.api.java.JavaPairDStream</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.streaming.api.java.JavaReceiverInputDStream</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.streaming.api.java.JavaStreamingContext</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>scala.Tuple2</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>java.util.Arrays</span><span class=p>;</span>

  <span class=kd>public</span> <span class=kd>class</span> <span class=nc>Stream</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=p>{</span>
        <span class=n>SparkConf</span> <span class=n>conf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SparkConf</span><span class=p>()</span>
            <span class=p>.</span><span class=na>setAppName</span><span class=p>(</span><span class=s>&quot;NetworkWordCount&quot;</span><span class=p>)</span>
            <span class=p>.</span><span class=na>setMaster</span><span class=p>(</span><span class=s>&quot;local[*]&quot;</span><span class=p>);</span>
        <span class=n>JavaStreamingContext</span> <span class=n>jssc</span> <span class=o>=</span>
            <span class=k>new</span> <span class=n>JavaStreamingContext</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span> <span class=n>Durations</span><span class=p>.</span><span class=na>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>

        <span class=n>JavaReceiverInputDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>lines</span> <span class=o>=</span>
            <span class=n>jssc</span><span class=p>.</span><span class=na>socketTextStream</span><span class=p>(</span><span class=s>&quot;localhost&quot;</span><span class=p>,</span> <span class=mi>9999</span><span class=p>);</span>

        <span class=n>JavaDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>words</span> <span class=o>=</span>
            <span class=n>lines</span><span class=p>.</span><span class=na>flatMap</span><span class=p>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&quot; &quot;</span><span class=p>)).</span><span class=na>iterator</span><span class=p>());</span>
        <span class=n>JavaPairDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>pairs</span> <span class=o>=</span>
            <span class=n>words</span><span class=p>.</span><span class=na>mapToPair</span><span class=p>(</span><span class=n>s</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Tuple2</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>1</span><span class=p>));</span>
        <span class=n>JavaPairDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>wordCounts</span> <span class=o>=</span>
            <span class=n>pairs</span><span class=p>.</span><span class=na>reduceByKey</span><span class=p>((</span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>i1</span> <span class=o>+</span> <span class=n>i2</span><span class=p>);</span>

        <span class=n>wordCounts</span><span class=p>.</span><span class=na>print</span><span class=p>();</span>
        <span class=n>jssc</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
        <span class=n>jssc</span><span class=p>.</span><span class=na>awaitTermination</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></div> <p>Ce code permet de calculer le nombre de mots dans un stream de données toutes les secondes.</p> <h4 id=test-du-code-en-local>Test du code en Local<a class=headerlink href=#test-du-code-en-local title="Permanent link">&para;</a></h4> <p>Le stream ici sera diffusé par une petite commande utilitaire qui se trouve dans la majorité des systèmes Unix-like.</p> <ul> <li>Exécuter votre classe <em>Stream</em>. Vous verrez défiler sur votre console des lignes en continu: l'application est en écoute sur localhost:9999.</li> <li>Ouvrir un terminal, et taper la commande suivante pour créer le stream: <div class=highlight><pre><span></span><code>  nc -lk <span class=m>9999</span>
</code></pre></div> Vous pourrez alors taper les entrées de votre choix.</li> </ul> <div class="admonition note"> <p class=admonition-title>Remarque</p> <p>L'équivalent de nc -lk sur Windows est l'utilitaure <a href=https://nmap.org/ncat/ >ncat</a></p> </div> <p>A chaque fois que vous entrez quelque chose sur le terminal, l'application l'intercepte, et l'affichage sur l'écran de la console change, comme suit:</p> <p><img alt="Test Streaming" src=../img/p6/stream-intercepted.png></p> <p>Ainsi, chaque seconde, le programme exécute un wordcount sur la chaine entrée dans la fenêtre du terminal.</p> <h4 id=lancement-du-code-sur-le-cluster>Lancement du code sur le cluster<a class=headerlink href=#lancement-du-code-sur-le-cluster title="Permanent link">&para;</a></h4> <p>Pour lancer le code précédent sur le cluster, il faudra d'abord faire des petites modifications:</p> <div class=highlight><pre><span></span><code>    <span class=kd>public</span> <span class=kd>class</span> <span class=nc>Stream</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=p>{</span>
<span class=hll>        <span class=n>SparkConf</span> <span class=n>conf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SparkConf</span><span class=p>().</span><span class=na>setAppName</span><span class=p>(</span><span class=s>&quot;NetworkWordCount&quot;</span><span class=p>);</span>
</span>        <span class=n>JavaStreamingContext</span> <span class=n>jssc</span> <span class=o>=</span>
            <span class=k>new</span> <span class=n>JavaStreamingContext</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span> <span class=n>Durations</span><span class=p>.</span><span class=na>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>

<span class=hll>        <span class=n>JavaReceiverInputDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>lines</span> <span class=o>=</span>
</span><span class=hll>            <span class=n>jssc</span><span class=p>.</span><span class=na>socketTextStream</span><span class=p>(</span><span class=s>&quot;&lt;votre-ip&gt;&quot;</span><span class=p>,</span> <span class=mi>9999</span><span class=p>);</span>
</span>
        <span class=n>JavaDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>words</span> <span class=o>=</span>
            <span class=n>lines</span><span class=p>.</span><span class=na>flatMap</span><span class=p>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&quot; &quot;</span><span class=p>)).</span><span class=na>iterator</span><span class=p>());</span>
        <span class=n>JavaPairDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>pairs</span> <span class=o>=</span>
            <span class=n>words</span><span class=p>.</span><span class=na>mapToPair</span><span class=p>(</span><span class=n>s</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Tuple2</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>1</span><span class=p>));</span>
        <span class=n>JavaPairDStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>wordCounts</span> <span class=o>=</span>
            <span class=n>pairs</span><span class=p>.</span><span class=na>reduceByKey</span><span class=p>((</span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>i1</span> <span class=o>+</span> <span class=n>i2</span><span class=p>);</span>

        <span class=n>wordCounts</span><span class=p>.</span><span class=na>print</span><span class=p>();</span>
        <span class=n>jssc</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
        <span class=n>jssc</span><span class=p>.</span><span class=na>awaitTermination</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></div> <div class="admonition warning"> <p class=admonition-title>Attention</p> <p>Veillez à mettre l'IP de votre machine locale (sur laquelle vous allez lancer le flux avec <em>nc</em>) à la place de &lt;votre-ip>. Vous pourrez trouver votre IP avec la commande ifconfig (pour les systèmes Linux/Mac) ou ipconfig (pour les systèmes Windows).</p> </div> <p>Les détails de la réalisation des étapes suivantes sont semblables à celles réalisées dans la Partie <a href=../p4-batch/index.html#lancement-du-code-sur-le-cluster>P4 - RDD et Batch Processing avec Spark</a></p> <ul> <li>Lancer un <code>mvn package install</code>pour créer le fichier jar.</li> <li>Copier le fichier jar sur le contenaire maître du cluster spark.</li> <li>Lancer la commande suivante:</li> </ul> <div class=highlight><pre><span></span><code>    spark-submit --class tn.spark.streaming.Stream
                 --master <span class=nb>local</span>
                 stream-1.jar
</code></pre></div> <p>En arrêtant l'exécution du flux (taper pour cela <code>Ctrl-C</code>), et en revenant en arrière dans le terminal, vous constaterez que le calcul du nombre de mots est fait de façon périodique:</p> <p><img alt="Test Streaming" src=../img/p6/stream-result.png></p> <h3 id=references>Références<a class=headerlink href=#references title="Permanent link">&para;</a></h3> <p>[^spark-official]: Spark Documentation, <em>Spark Streaming Programming Guide</em>, <a href=https://spark.apache.org/docs/latest/streaming-programming-guide.html>https://spark.apache.org/docs/latest/streaming-programming-guide.html</a>, consulté le 04/2020</p> <p>[^data-flair]: Data Flair, <em>Spark Tutorial: Learn Spark Programming</em>, <a href=https://data-flair.training/blogs/spark-tutorial/ >https://data-flair.training/blogs/spark-tutorial/</a>, consulté le 03/2020</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2020-05-04T16:24:31+01:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2020-05-04</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../p5-sql/ class="md-footer__link md-footer__link--prev" aria-label="Previous: P5 - Spark SQL" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> P5 - Spark SQL </div> </div> </a> <a href=../p7-ml/ class="md-footer__link md-footer__link--next" aria-label="Next: P7 - Spark MLLib" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> P7 - Spark MLLib </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2019 - 2020 Lilia Sfaxi </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../assets/javascripts/bundle.e3b2bf44.min.js></script> <script src=../js/timeago.min.js></script> <script src=../js/timeago_mkdocs_material.js></script> </body> </html>