



<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Cours et Travaux Pratiques pour se familiariser avec Apache Spark">
      
      
        <link rel="canonical" href="http://liliasfaxi.github.io/Atelier-Spark/p8-graphx/">
      
      
        <meta name="author" content="Lilia Sfaxi">
      
      
        <meta name="lang:clipboard.copy" content="Copier dans le presse-papier">
      
        <meta name="lang:clipboard.copied" content="Copié dans le presse-papier">
      
        <meta name="lang:search.language" content="fr">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="Aucun document trouvé">
      
        <meta name="lang:search.result.one" content="1 document trouvé">
      
        <meta name="lang:search.result.other" content="# documents trouvés">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>P8 - Spark GraphX - Atelier Apache Spark</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "None", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="amber">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#partie-8-spark-graphx" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://liliasfaxi.github.io/Atelier-Spark/" title="Atelier Apache Spark" class="md-header-nav__button md-logo">
          
            <img src="../img/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Atelier Apache Spark
            </span>
            <span class="md-header-nav__topic">
              
                P8 - Spark GraphX
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Taper pour démarrer la recherche
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/liliasfaxi/Atelier-Spark/" title="Aller au dépôt" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    liliasfaxi/Atelier-Spark
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://liliasfaxi.github.io/Atelier-Spark/" title="Atelier Apache Spark" class="md-nav__button md-logo">
      
        <img src="../img/logo.png" width="48" height="48">
      
    </a>
    Atelier Apache Spark
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/liliasfaxi/Atelier-Spark/" title="Aller au dépôt" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    liliasfaxi/Atelier-Spark
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Atelier Apache Spark" class="md-nav__link">
      Atelier Apache Spark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p1-big-data/" title="P1 - Introduction au Big Data" class="md-nav__link">
      P1 - Introduction au Big Data
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p2-spark/" title="P2 - Introduction à Apache Spark" class="md-nav__link">
      P2 - Introduction à Apache Spark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p3-install/" title="P3 - Installation de Spark" class="md-nav__link">
      P3 - Installation de Spark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p4-batch/" title="P4 - RDD et Batch Processing avec Spark" class="md-nav__link">
      P4 - RDD et Batch Processing avec Spark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p5-sql/" title="P5 - Spark SQL" class="md-nav__link">
      P5 - Spark SQL
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p6-stream/" title="P6 - Spark Streaming" class="md-nav__link">
      P6 - Spark Streaming
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../p7-ml/" title="P7 - Spark MLLib" class="md-nav__link">
      P7 - Spark MLLib
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        P8 - Spark GraphX
      </label>
    
    <a href="./" title="P8 - Spark GraphX" class="md-nav__link md-nav__link--active">
      P8 - Spark GraphX
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table des matières</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#presentation-de-spark-graphx" class="md-nav__link">
    Présentation de Spark GraphX
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphes-de-proprietes" class="md-nav__link">
    Graphes de Propriétés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-graphx" class="md-nav__link">
    Opérateurs GraphX
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operateurs-structurels" class="md-nav__link">
    Opérateurs structurels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-de-jointure" class="md-nav__link">
    Opérateurs de jointure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-dagregation-et-de-voisinage" class="md-nav__link">
    Opérateurs d'agrégation et de voisinage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristiques-de-spark-graphx" class="md-nav__link">
    Caractéristiques de Spark GraphX
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exemple-dapplication-graphx" class="md-nav__link">
    Exemple d'Application GraphX
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    Références
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table des matières</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#presentation-de-spark-graphx" class="md-nav__link">
    Présentation de Spark GraphX
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphes-de-proprietes" class="md-nav__link">
    Graphes de Propriétés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-graphx" class="md-nav__link">
    Opérateurs GraphX
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operateurs-structurels" class="md-nav__link">
    Opérateurs structurels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-de-jointure" class="md-nav__link">
    Opérateurs de jointure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operateurs-dagregation-et-de-voisinage" class="md-nav__link">
    Opérateurs d'agrégation et de voisinage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristiques-de-spark-graphx" class="md-nav__link">
    Caractéristiques de Spark GraphX
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exemple-dapplication-graphx" class="md-nav__link">
    Exemple d'Application GraphX
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    Références
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/liliasfaxi/Atelier-Spark/edit/master/docs/p8-graphx.md" title="Editer cette page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="partie-8-spark-graphx">Partie 8 - Spark GraphX</h1>
<p><center><img src="../img/p8/graphx.png" width="600pt"></center></p>
<h2 id="presentation-de-spark-graphx">Présentation de Spark GraphX</h2>
<p>Spark GraphX<sup id="fnref:spark-official"><a class="footnote-ref" href="#fn:spark-official">1</a></sup> est un composant Spark permettant le traitement à base de graphes. A un niveau élevé, GraphX étend la structure Spark RDD en introduisant une abstraction sous forme d'un graphe dirigé formé de sommets (<em>vertex</em>) et d'arêtes (<em>edge</em>), auxquels sont attachées des propriétés.<br />
Pour gérer ces structures, GraphX propose un ensemble d'opérateurs ainsi qu'une version optimisée de l'API <a href="https://spark.apache.org/docs/latest/graphx-programming-guide.html#pregel">Pregel</a>. De plus, plusieurs algorithmes et constructeurs (<em>builders</em>) sont définis pour simplifier le traitement et analyse de ces graphes.</p>
<h3 id="graphes-de-proprietes">Graphes de Propriétés</h3>
<p>Un graphe de propriétés est un multigraphe dirigé contenant des objets définis par l'utilisateur attachés à chaque sommet et arête. Un multigraphe est un graphe dirigé qui peut contenir plusieurs arêtes reliant les mêmes sommets source et destination, permettant ainsi de modéliser des situations où les sommets peuvent avoir plusieurs types de relations. Chaque sommet est représenté par un identifiant unique de 64 bits (<em>VertexId</em>). Les arêtes doivent avoir chacune un sommet source et un sommet destination.</p>
<p>Un graphe de propriété est paramétrisé par deux types: un sommet (<em>Vertex</em> appelé <em>VD</em>) et une arête (<em>Edge</em> appelé <em>ED</em>). Ces types optimisés remplacent les types classiques, même primitifs, de façon a réduire la taille en mémoire réservée.</p>
<p>Pour définir des types personnalisés pour les sommets, il est préférable d'utiliser l'héritage. Par exemple, pour définir des sommets de type <em>Utilisateur</em> et d'autres de type <em>Produit</em>, on peut créer les classes suivantes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">class</span> <span class="nc">VertexProperty</span><span class="o">()</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">UserProperty</span><span class="o">(</span><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">VertexProperty</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">ProductProperty</span><span class="o">(</span><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">price</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">VertexProperty</span>
  <span class="c1">// Le graphe peut alors avoir le type suivant:</span>
  <span class="k">var</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">VertexProperty</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span>
</pre></div>
</td></tr></table>

<p>Un graphe de propriétés correspond à une paire de RDDs contenant des propriétés pour chaque sommet et arête. En conséquence, la classe <em>Graph</em> contient des membres permettant d'accéder aux sommets et arêtes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">class</span> <span class="nc">Graph</span><span class="o">[</span><span class="kt">VD</span>, <span class="kt">ED</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">vertices</span><span class="k">:</span> <span class="kt">VertexRDD</span><span class="o">[</span><span class="kt">VD</span><span class="o">]</span>
    <span class="k">val</span> <span class="n">edges</span><span class="k">:</span> <span class="kt">EdgeRDD</span><span class="o">[</span><span class="kt">ED</span><span class="o">]</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Les classes <code class="codehilite"><span class="n">VertexRDD</span><span class="p">[</span><span class="n">VD</span><span class="p">]</span></code> et <code class="codehilite"><span class="n">EdgeRDD</span><span class="p">[</span><span class="n">RD</span><span class="p">]</span></code> sont des versions optimisées des RDD qui fournissent des fonctionnalités supplémentaires pour le traitement et optimisation des graphes.</p>
<p>Nous présentons dans ce qui suit un exemple de graphe de propriétés montrant plusieurs collaborateurs dans un projet de recherche:<br />
<center><img src="../img/p8/property_graph.png" width="600pt"></center></p>
<p>En plus des sommets et arêtes du graphe de propriétés, GraphX présente également une vue en <em>triplet</em>. Cette vue permet de faire la jointure des propriétés des sommets et arêtes, équivalente à l'expression SQL suivante:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">SELECT</span> <span class="n">src</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dst</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">dst</span><span class="p">.</span><span class="n">attr</span>
  <span class="k">FROM</span> <span class="n">edges</span> <span class="k">AS</span> <span class="n">e</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">vertices</span> <span class="k">AS</span> <span class="n">src</span><span class="p">,</span> <span class="n">vertices</span> <span class="k">AS</span> <span class="n">dst</span>
  <span class="k">ON</span> <span class="n">e</span><span class="p">.</span><span class="n">srcId</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">Id</span> <span class="k">AND</span> <span class="n">e</span><span class="p">.</span><span class="n">dstId</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">Id</span>
</pre></div>
</td></tr></table>

<p>Ceci correspond graphiquement à la figure suivante:<br />
<center><img src="../img/p8/triplet.png" width="600pt"></center></p>
<p>La classe <code class="codehilite"><span class="n">EdgeTriplet</span></code> étend la classe <code class="codehilite"><span class="n">Edge</span></code> en ajoutant les attributs <code class="codehilite"><span class="n">srcAttr</span></code> et <code class="codehilite"><span class="n">dstAttr</span></code> qui contiennent les propriétés source et destination. Le code ressemblera à ce qui suit:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)</span>, <span class="kt">String</span><span class="o">]</span>
  <span class="c1">// Utiliser les triplets pour créer un RDD de faits</span>
  <span class="k">val</span> <span class="n">facts</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>  <span class="n">graph</span><span class="o">.</span><span class="n">triplets</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">triplet</span> <span class="k">=&gt;</span>
    <span class="n">triplet</span><span class="o">.</span><span class="n">srcAttr</span><span class="o">.</span><span class="n">_1</span> <span class="o">+</span> <span class="s">&quot; est le &quot;</span> <span class="o">+</span> <span class="n">triplet</span><span class="o">.</span><span class="n">attr</span> <span class="o">+</span> <span class="s">&quot; de &quot;</span> <span class="o">+</span> <span class="n">triplet</span><span class="o">.</span><span class="n">dstAttr</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span>
  <span class="n">facts</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</pre></div>
</td></tr></table>

<h3 id="operateurs-graphx">Opérateurs GraphX</h3>
<p>De même que pour les RDDs, les graphes de propriétés ont également un ensemble d'opérateurs qui prennent des fonctions définies par l'utilisateur et produisent de nouveaux graphes avec des propriétés et une structure modifiées.</p>
<p>Les opérateurs utilisés sont divisés en plusieurs types:</p>
<h4 id="operateurs-structurels">Opérateurs structurels</h4>
<p>GraphX supporte quelques opérateurs qui modifient la structure du graphe:</p>
<ul>
<li><code class="codehilite"><span class="n">reverse</span></code>: retourne un nouveau graphe avec toutes les directions des arêtes inversées.</li>
<li><code class="codehilite"><span class="n">subgraph</span></code>: retourne le sous-ensemble du graphe qui contient les sommets et arêtes respectant les contraintes définies en paramètre, ainsi que toutes les arêtes connectant les sommets respectant ces contraintes.</li>
<li><code class="codehilite"><span class="n">mask</span></code>: retourne un sous-graphe qui contient les sommets et arêtes qui existent aussi dans le graphe donné en entrée.</li>
</ul>
<h4 id="operateurs-de-jointure">Opérateurs de jointure</h4>
<p>Ces opérateurs permettent de joindre des données à partir de RDD externes avec des graphes. Deux opérateurs sont définis:</p>
<ul>
<li><code class="codehilite"><span class="n">joinVertices</span></code>: joint les sommets avec le RDD en entrée et retourne un nouveau graphe avec les propriétés du sommet obtenues en appliquant la fonction <code class="codehilite"><span class="n">map</span></code> définie par l'utilisateur au résultat des sommets joints.</li>
<li><code class="codehilite"><span class="n">outerJoinVertices</span></code>: se comporte comme <code class="codehilite"><span class="n">joinVertices</span></code> mais la fonction <code class="codehilite"><span class="n">map</span></code> est appliquée à tous les sommets et peut changer le type de la propriété de l'arête.</li>
</ul>
<h4 id="operateurs-dagregation-et-de-voisinage">Opérateurs d'agrégation et de voisinage</h4>
<p>Les opérateurs d'agrégation permettent de réunir des information sur le voisinage de chaque sommet.</p>
<ul>
<li><code class="codehilite"><span class="n">aggregateMessages</span></code> applique une fonction définie par l'utilisateur <code class="codehilite"><span class="n">sendMsg</span></code> à chaque triplet du graphe et utilise la fonction <code class="codehilite"><span class="n">mergeMsg</span></code>pour agréger ces messages dans leur sommet destination. Permet également de faire des opérations de type <em>map/reduce</em>  en remplaçant l'opérateur <code class="codehilite"><span class="n">mapReduceTriplets</span></code> qui existait dans les anciennes versions de GraphX.</li>
<li><code class="codehilite"><span class="n">collectNeighborIds</span></code> et <code class="codehilite"><span class="n">collectNeighbors</span></code>: permettent de collecter les sommets et les attributs voisins d'un sommet donné.</li>
<li><code class="codehilite"><span class="n">degrees</span></code>, <code class="codehilite"><span class="n">inDegrees</span></code> et <code class="codehilite"><span class="n">outDegrees</span></code>: permettent de calculer le degré de chaque sommet, c'est à dire le nombre d'arêtes qui lui sont liées.</li>
</ul>
<h3 id="caracteristiques-de-spark-graphx">Caractéristiques de Spark GraphX</h3>
<ol>
<li><strong>Flexibilité</strong>: GraphX utilise les graphes pour le traitement. Il unifie les opérations d'ETL (<em>Extract, Transform and Load</em>), l'analyse exploratoire et le traitement itératif dans un seul système.</li>
<li><strong>Vitesse</strong>: Spark GraphX fournit une performance comparable aux systèmes de traitement de graphes spécialisés les plus performants.</li>
<li><strong>Bibliothèque en expension</strong>: la bibliothèque de Graphx est en continuelle expension, et fournit des algorithmes prêts à l'emploi tel que <em>PageRank</em>, <em>SVD</em>, etc.</li>
</ol>
<h2 id="exemple-dapplication-graphx">Exemple d'Application GraphX</h2>
<p>Nous allons implémenter dans cet exemple (inspiré du tutoriel dans <sup id="fnref:edureka"><a class="footnote-ref" href="#fn:edureka">2</a></sup>), un petit réseau social entre plusieurs personnes, tel que représenté dans l'image suivante:<br />
<center><img src="../img/p8/social.png" width="400pt"></center></p>
<p>Nous allons utiliser spark shell et le langage Scala pour cet exemple.</p>
<ol>
<li>Lancer votre cluster spark, entrer dans le contenaire master, et lancer spark-shell:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  docker start spark-master spark-slave1 spark-slave2
  docker <span class="nb">exec</span> -it spark-master bash
  spark-shell
</pre></div>
</td></tr></table></li>
<li>Commencer par importer les classes nécessaires:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">import</span> <span class="nn">org.apache.spark._</span>
  <span class="k">import</span> <span class="nn">org.apache.spark.rdd.RDD</span>
  <span class="k">import</span> <span class="nn">org.apache.spark.util.IntParam</span>
  <span class="k">import</span> <span class="nn">org.apache.spark.graphx._</span>
  <span class="k">import</span> <span class="nn">org.apache.spark.graphx.util.GraphGenerators</span>
</pre></div>
</td></tr></table></li>
<li>Créer les tableaux contenant les sommets et les arêtes:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">val</span> <span class="n">sommets</span><span class="k">=</span> <span class="nc">Array</span>  <span class="o">((</span><span class="mi">1L</span><span class="o">,(</span><span class="s">&quot;Alia&quot;</span><span class="o">,</span><span class="mi">28</span><span class="o">)),(</span><span class="mi">2L</span><span class="o">,(</span><span class="s">&quot;Bechir&quot;</span><span class="o">,</span><span class="mi">27</span><span class="o">)),(</span><span class="mi">3L</span><span class="o">,(</span><span class="s">&quot;Chiheb&quot;</span><span class="o">,</span><span class="mi">65</span><span class="o">)),</span>
                      <span class="o">(</span><span class="mi">4L</span><span class="o">,(</span><span class="s">&quot;Delia&quot;</span><span class="o">,</span><span class="mi">42</span><span class="o">)),(</span><span class="mi">5L</span><span class="o">,(</span><span class="s">&quot;Emir&quot;</span><span class="o">,</span><span class="mi">35</span><span class="o">)),(</span><span class="mi">6L</span><span class="o">,(</span><span class="s">&quot;Fawzi&quot;</span><span class="o">,</span><span class="mi">50</span><span class="o">)))</span>
  <span class="k">val</span> <span class="n">aretes</span> <span class="k">=</span> <span class="nc">Array</span> <span class="o">(</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span>
                      <span class="nc">Edge</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">),</span><span class="nc">Edge</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="s">&quot;follows&quot;</span><span class="o">))</span>
</pre></div>
</td></tr></table><br />
  4.Créer les RDD associé en parallelisant les tableaux précedents:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">val</span> <span class="n">sommetRDD</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[(</span><span class="kt">Long</span>, <span class="o">(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">))]</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">sommets</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">areteRDD</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">Edge</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">aretes</span><span class="o">)</span>
</pre></div>
</td></tr></table></li>
<li>Constuire le graphe à partir des RDD:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Graph</span><span class="o">(</span><span class="n">sommetRDD</span><span class="o">,</span> <span class="n">areteRDD</span><span class="o">)</span>
</pre></div>
</td></tr></table></li>
<li>Nous allons ensuite afficher la liste des personnes ainsi que leurs ages:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">filter</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">(</span><span class="n">nom</span><span class="o">,</span> <span class="n">age</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="o">}.</span><span class="n">collect</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">(</span><span class="n">nom</span><span class="o">,</span> <span class="n">age</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;$nom a $age ans&quot;</span><span class="o">)}</span>
</pre></div>
</td></tr></table><br />
  Le résultat obtenu ressemble à ce qui suit:<br />
<center><img src="../img/p8/filtrage.png" width="400pt"></center></li>
<li>Nous allons maintenant afficher les relations de "follow": qui suit qui? Pour cela, écrire le code suivant:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="k">for</span> <span class="o">(</span><span class="n">triplet</span> <span class="k">&lt;-</span> <span class="n">graph</span><span class="o">.</span><span class="n">triplets</span><span class="o">.</span><span class="n">collect</span><span class="o">){</span>
    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;${triplet.srcAttr._1} suit ${triplet.dstAttr._1}&quot;</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table><br />
    Le résultat obtenu ressemble à ce qui suit:<br />
  <center><img src="../img/p8/suit.png" width="400pt"></center></li>
<li>
<p>Trouvons le nombre d'abonnés pour chaque utilisateur:<br />
  <table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="c1">// Définir une classe pour modéliser un utilisateur</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Utilisateur</span><span class="o">(</span><span class="n">nom</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">inDeg</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">outDeg</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="c1">// Créer un graphe pour l&#39;utilisateur</span>
  <span class="k">val</span> <span class="n">initialUserGraph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Utilisateur</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">mapVertices</span><span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">(</span><span class="n">nom</span><span class="o">,</span> <span class="n">age</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Utilisateur</span><span class="o">(</span><span class="n">nom</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">}</span>

  <span class="c1">// Remplir les informations</span>
  <span class="k">val</span> <span class="n">userGraph</span> <span class="k">=</span> <span class="n">initialUserGraph</span><span class="o">.</span><span class="n">outerJoinVertices</span><span class="o">(</span><span class="n">initialUserGraph</span><span class="o">.</span><span class="n">inDegrees</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">inDegOpt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Utilisateur</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">nom</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">age</span><span class="o">,</span> <span class="n">inDegOpt</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">u</span><span class="o">.</span><span class="n">outDeg</span><span class="o">)}.</span><span class="n">outerJoinVertices</span><span class="o">(</span><span class="n">initialUserGraph</span><span class="o">.</span><span class="n">outDegrees</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">outDegOpt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Utilisateur</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">nom</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">age</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">inDeg</span><span class="o">,</span> <span class="n">outDegOpt</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="c1">// Afficher les résultats</span>
  <span class="k">for</span> <span class="o">((</span><span class="n">id</span><span class="o">,</span> <span class="n">prop</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">userGraph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">collect</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Utilisateur $id s&#39;appelle ${prop.nom} et est suivi par ${prop.inDeg} personnes.&quot;</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table><br />
  Le résultat obtenu ressemble à ce qui suit:<br />
  <center><img src="../img/p8/nombre.png" width="400pt"></center></p>
<ol>
<li>Et si on veut afficher l'abonné le plus âgé?<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="c1">// Chaque abonné envoie un message avec son age (c&#39;est le deuxième attribut detype Int du sommet en question) =&gt; équivalent de la fonction map</span>
  <span class="k">def</span> <span class="n">msgFun</span><span class="o">(</span><span class="n">triplet</span><span class="k">:</span><span class="kt">EdgeContext</span><span class="o">[(</span><span class="kt">String</span>,<span class="kt">Int</span><span class="o">)</span>,<span class="kt">String</span>,<span class="kt">Int</span><span class="o">]){</span>
    <span class="n">triplet</span><span class="o">.</span><span class="n">sendToDst</span><span class="o">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">srcAttr</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Pour chaque couple d&#39;âges reçus, retenir la valeur la plus grande =&gt; équivalent de la fonction reduce</span>
  <span class="k">def</span> <span class="n">reduceFun</span><span class="o">(</span><span class="n">a</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span><span class="n">b</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">)</span> <span class="n">a</span> <span class="k">else</span> <span class="n">b</span>

  <span class="c1">// Exécuter les deux opérations pour chaque triplet du graphe</span>
  <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">aggregateMessages</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">msgFun</span><span class="o">,</span> <span class="n">reduceFun</span><span class="o">)</span>

  <span class="c1">// Afficher le résultat obtenu</span>
  <span class="n">result</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">age</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;L&#39;abonne le plus age de l&#39;utilisateur $id a $age ans&quot;</span><span class="o">)}</span>
</pre></div>
</td></tr></table><br />
Le résultat obtenu ressemble à ce qui suit:<br />
<center><img src="../img/p8/age.png" width="400pt"></center></li>
</ol>
</li>
</ol>
<h2 id="references">Références</h2>
<div class="footnote">
<hr />
<ol>
<li id="fn:spark-official">
<p>Spark Documentation, <em>Spark GraphX Guide</em>, <a href="https://spark.apache.org/docs/latest/graphx-programming-guide.html">https://spark.apache.org/docs/latest/graphx-programming-guide.html</a>, consulté le 05/2020&#160;<a class="footnote-backref" href="#fnref:spark-official" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:edureka">
<p>Edureka, <em>Spark GraphX Tutorial – Graph Analytics In Apache Spark</em>, <a href="https://www.edureka.co/blog/spark-graphx/">https://www.edureka.co/blog/spark-graphx/</a>, consulté le 05/2020&#160;<a class="footnote-backref" href="#fnref:edureka" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../p7-ml/" title="P7 - Spark MLLib" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Précédent
                </span>
                P7 - Spark MLLib
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 - 2020 Lilia Sfaxi
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="http://liliasfaxi.wix.com/liliasfaxi" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/liliasfaxi" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/lillitou" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/liliasfaxi/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../assets/javascripts/lunr/lunr.fr.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
  </body>
</html>